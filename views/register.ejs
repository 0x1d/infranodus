<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link rel="stylesheet" href="/stylesheets/side-menu.css">
    <script src="https://js.chargebee.com/v2/chargebee.js"></script>
    <script src="/javascripts/jquery.min.js"></script>

</head>
<body>

<% include statsabove %>

<div id="layout">
    <!-- Menu toggle -->
    <a href="#menu" id="menuLink" class="menu-link">
        <!-- Hamburger icon -->
        <span></span>
    </a>

    <% include menu %>

    <div id="content">
          <div id="welcomemessage">
              <p>Please, create a user account below to start using InfraNodus.<br><br>
                This open source tool is developed by Nodus Labs without investors or external funds, therefore we ask you to make a small contribution to help finance our work. You will get a 14-day trial period to evaluate the product and you can cancel at any time. </p>

              <% include messages %>

              <div class="warning" id="errors"></div>

                <form action='/signup' id="registration_form" method='post' class="pure-form pure-form-stacked">


                    <p>
                        <input type='text' name='username' id="username" placeholder='username' />
                    </p>
                    <p>
                        <input type='password' name='password' placeholder='password' />
                    </p>
                    <p>
                        <input type='email' name='email' placeholder='email' />
                    </p>

                    <p>
                        <input type='text' name='invite' id='invitation' placeholder='invitation code' />
                    </p>
                    <p>

                      <div class="small-caption">
                      do you accept our <a href="https://infranodus.com/infranodus/privacypolicy?maxnodes=90" target="_blank">privacy policy</a> and do you consent to receive updates from us<br>

                      </div>
                      <input type='checkbox' name='consent' value='yes'/>

                    </p>
                    <p>
                        <button type='submit' id='register' class="pure-button pure-button-primary">create account</button>
                    </p>
                </form>

          </div>
    </div>

</div>

<script src="/javascripts/ui.js"></script>


<script>
document.addEventListener("DOMContentLoaded", function() {

    var cbInstance = window.Chargebee.init({site: "infranodus-test"});

    var account_created;



    $("#register").click(function(event){


      event.preventDefault();

      $.post('/signup', $("#registration_form").serialize())
              .done(function(res) {
                  if (res.errormsg) {
                    $('#errors').html(res.errormsg);
                  }
                  else if (res.moveon) {
                    window.location.href = res.moveon;
                  }
                  else {
                    $('#errors').html('');
                    cbInstance.openCheckout({
                      hostedPage: function() {
                        // Hit your end point that returns hosted page object as response
                        // This sample end point will call checkout new api
                        // https://apidocs.chargebee.com/docs/api/hosted_pages#checkout_new_subscription
                        // If you want to use paypal, go cardless and plaid, pass embed parameter as false
                        return new Promise(function(resolve, reject){
                          var obtainedResponse = res.hosted_page;
                          resolve(obtainedResponse);
                        });
                        },
                        loaded: function() {
                          console.log("checkout opened");
                        },
                        error: function() {
                          console.log("error");
                          $('#errors').html('There was an error with the sign up process. Please, try again and if it doesn\'t work, <a href="http://noduslabs.com/contact/"">contact us</a>, so we can sort this out for you. Thanks!');
                        },
                        close: function() {
                          console.log("checkout closed");
                          if (account_created == 'success') {
                            $('#errors').html('It appears like the checkout process ended abruptly. Your account appears to have been created, so, please, <a href="/login?login=' + $('#username').val() + '">try to log in using your details</a>.');
                          }
                          else {
                            $('#errors').html('It appears like the checkout process ended abruptly. Your account may have not been created. Please, try to submit this form again using the same details.');
                          }
                        },
                        success: function(hostedPageId) {
                          console.log(hostedPageId);
                           // Hosted page id will be unique token for the checkout that happened
                           // You can pass this hosted page id to your backend
                           // and then call our retrieve hosted page api to get subscription details
                           $.post('/signup', $("#registration_form").serialize() + '&hostedPage=' + hostedPageId)
                                   .done(function(res) {
                                     account_created = 'success';
                                   })
                                   .fail(function(res) {
                                       console.log(res);
                                   });
                        },
                        step: function(value) {
                          // value -> which step in checkout
                          console.log(value);
                        }
                      });

                  }

              })
              .fail(function(res) {
                  console.log(res);
              });




      });



});

</script>

<% include statsbelow %>

</body>
</html>
