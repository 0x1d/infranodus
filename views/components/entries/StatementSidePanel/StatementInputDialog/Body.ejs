 
<div id="edit-panel">
    <form action='/post' name='submitform' id="submitform" method='post' class='pure-form'>

            <textarea columns="40" rows="4" name='entry[body]' id="statement" placeholder='type in some words or #hashtags to see how they connect'><% if (url) { %><%= urltitle %> <%= url %><% } %></textarea>
            <div id="addToContextsLabel">in context:</div>
            <ul id="addToContexts"></ul>
            <input type="hidden" id="addedContexts" name="addedContexts">
            <input type="hidden" id="context" name="context" value="<%= context %>">
            <input type="hidden" id="selectedContexts" name="selectedContexts" value="">
            <input type="hidden" id="statementid" name="statementid" value="">
            <input type="hidden" name="timestamp" value="">
            &nbsp;<br>
            <input type='submit' id="submitbutton" name="btnSubmit" value="save" class="pure-button pure-button-primary">

    </form>
</div>

<div id="search-panel">
    <form class="pure-form" id="searchform">
        <input type="text" id="search" size="14" maxlength="20" class="pure-input" placeholder="search...">
        &nbsp;&nbsp;
        <input type='submit' name="submit" value=">" class="pure-button pure-button-primary">
    </form>
</div>

<script>
    
    searchForm().onSubmit(submitSearchForm);

    addEntryForm().activate();

    addEntryForm().onSubmit(submitEditForm);

    function searchForm() {
        return {
            autofill: function() {
                autoComplete('#search',graphFactory.getNodeNames());  
            },
            onSubmit: function(onSubmit) {   
                $('#searchform').on('submit', onSubmit);
            }
        }
    }

    function addEntryForm() {
        return {
            update: function(content) {          
                if ($('#statement').val().length == 0 || $('#statement').val().charAt(0) == '#') {
                    $('#statement').val(arrayToHashtagString(content));
                }
            },
            onSubmit: function(onSubmit) {
                $('#submitform').on('submit', onSubmit);
            },
            activate: function() {
                // Submit the form on enter
                $('#statement').keypress(function(e){            
                    if(e.which == 13 && !e.shiftKey) {
                        e.preventDefault();
                        $('#submitbutton').trigger('click');
                    }
                });
            }
        }
    }


    function submitSearchForm(e) {

    
        e.preventDefault();
        // What are we searching?
        var searchPhrase = $('#search').val();

        if (searchPhrase.length > 1) {

            // Clean up the search string
            searchPhrase = searchPhrase.replace(/\s+/g,' ').trim();

            // Separate terms into array
            var searchArray = searchPhrase.toLowerCase().split(" ");

            var searchPhraseLemmas = [];


            for (var j = 0; j < searchArray.length; j++) {
                // Is the search term cyrillic?
                var search_cyrillic = searchArray[j].match(/[а-яА-Я]/);

                // SEARCHMOD
                // var search_lemma = window.jstemmer(searchArray[j]);

                var search_lemma = searchArray[j];

                searchPhraseLemmas.push(search_lemma);

            }

            for (var k = 0; k < searchPhraseLemmas.length; k++) {
                if (graphFactory.checkIfPinned(searchPhraseLemmas[k]) == false) {
                    graphFactory.addToPinnedNodes(searchPhraseLemmas[k]);
                }
            }

        }

    }
    

    function submitEditForm() {

        $('#statement').addClass('loading');

        $('#submitbutton').attr('disabled', 'disabled');

        if ($('#livetext').html().length > 0 && voice_continues) {
        $('#livetext').html($('#statement').val() + '<br><em>saving into the graph...</em><span></span>');
        setTimeout(function(){
            $('#livetext').html('<em>waiting...</em>' + ' <span></span>');
        }, 3000);
        }

        // We will set a user for posting. If the posting user does not equal the user who's watching the graph, we force-add the statement into theirs (provided they collaborate)
        var postedby = '';

        <% if (receivername) { %>
        postedby = '<%= receivername %>';
        <% } %>
        // TODO make it possible that those statements get submitted in both graphs

        // is urlvars mute off? then post as usual
        if (!mute) {
        $.post('/post', $("#submitform").serialize())
                .done(function(res) {
                    //3. Receive the server response, no need to emit an event
                    if (res.entryuid) {
                        //4. Show the updated text
                        selfPosted = '1';
                        $("#statement").val('');
                        $('#statement').removeClass('loading');
                        $('#submitbutton').removeAttr('disabled');

                        // This below if a few statements were posted
                        // TODO as we can now get all the s.uid back as an array this could be rewritten so no need for the condition after
                        if (res.entryuid == 'multiple') {
                            socket.emit('chat message', {postedby: postedby, entryuid: 'multiplesocket', entrytext: res.entrycontent, graph: res.graph});
                            if (res.successmsg) {
                            $("#warnings").append('<p class="warning">Please, reload the page after a few seconds to see the graph.</p>');
                            $("#warnings").slideDown('slow');
                            }
                            setTimeout(function() {
                                location.reload();
                            },3000);
                        }
                        else {
                            // Only one statement added? Initiate processing that will show it both to the user and the collaborator (if exists)
                            socket.emit('chat message', {postedby: postedby, entryuid: JSON.parse(res.entryuid).data, entrytext: res.entrytext, graph: res.graph});
                        }

                    }
                    else if (res.errormsg) {
                        $('#statement').removeClass('loading');
                        $('#submitbutton').removeAttr('disabled');
                        alert(res.errormsg);
                    }
                    else {
                        alert('Something went wrong, please, try again...');
                    }
                })
                .fail(function(res) {
                    alert("Server Error: " + res.status + " " + res.statusText);
                });

        }
        // otherwise - make a dummy post - it appears in the list but doesn't get submitted into the graph
        // This was made before to introduce a chat feature — so the software can "talk" to the user without adding stuff into the graph
        else {
            selfPosted = '1';
            $('#statement').removeClass('loading');
            $('#submitbutton').removeAttr('disabled');
            $("#statement").val('');
            socket.emit('chat message', {mute: 1, postedby: postedby, entryuid: '', entrytext: $('#statement').val(), graph: ''});
        }





        return false;
        
    }



    // Textarea select conversion to hashtags

    // For now it's disabled, but will be enabled for bulk statement correction later

    var getSelected = function(){
        var t = '';
        if(window.getSelection) {
            t = window.getSelection();
        } else if(document.getSelection) {
            t = document.getSelection();
        } else if(document.selection) {
            t = document.selection.createRange().text;
        }
        return t;
    }


    $("#statement").select(function(eventObject) {
        var selectedText = getSelected().toString();

        var statementReplace = $("#statement").val();

        if ((statementReplace.indexOf('@'+selectedText) === -1) && (selectedText !== statementReplace)) {

            var regex = RegExp(selectedText, "g");

            var dasherized = S(selectedText).underscore().chompLeft('_').s;

            // TODO check words for morphology (if found, alert)

            var replacedString = statementReplace.replace(regex,"#" + dasherized).replace(/##/g,'#');
            $("#statement").val(replacedString);
        }

    });



    




</script>